<div class="calendar-pro-container">
  <!-- Sidebar gauche -->
  <div class="calendar-sidebar">
    <!-- Salle d'attente -->
    <div class="waiting-room-widget card mb-3">
      <div class="card-header bg-warning text-dark">
        <i class="fas fa-clock"></i> Salle d'attente
        <span class="badge bg-dark float-end" id="waiting-count">0</span>
      </div>
      <div class="card-body p-0">
        <div id="waiting-list">
          <div class="text-center text-muted p-3">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <div>Chargement...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtres et légende -->
    <div class="card mb-3">
      <div class="card-header">
        <i class="fas fa-filter"></i> Filtres
      </div>
      <div class="card-body">
        <label class="form-label"><strong><i class="fas fa-user-md"></i> Médecin :</strong></label>
        <select id="medecin-filter" class="form-select mb-3">
          <option value="all">Tous les médecins</option>
          <% @medecins.each do |medecin| %>
            <option value="<%= medecin.id %>">Dr <%= medecin.full_name %></option>
          <% end %>
        </select>
        
        <label class="form-label"><strong><i class="fas fa-palette"></i> Légende :</strong></label>
        <div class="d-flex flex-column gap-2">
          <span class="badge" style="background-color: #f8bbd0; color: #000;">À venir</span>
          <span class="badge" style="background-color: #fff59d; color: #000;">En salle d'attente</span>
          <span class="badge" style="background-color: #a5d6a7; color: #000;">Vu</span>
          <span class="badge" style="background-color: #424242;">Encaissé</span>
          <span class="badge" style="background-color: #90caf9; color: #000;">Absent</span>
          <span class="badge" style="background-color: #b0bec5; color: #000;">Annulé</span>
        </div>
      </div>
    </div>

    <!-- Info astuce -->
    <div class="alert alert-info" role="alert" style="font-size: 0.85rem;">
      <i class="fas fa-info-circle"></i> 
      <strong>Astuce :</strong> Cliquez sur un créneau pour créer un RDV rapidement.
    </div>
  </div>

  <!-- Zone principale du calendrier -->
  <div class="calendar-main">
    <!-- Header -->
    <div class="calendar-header card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-calendar-alt"></i> Calendrier des Rendez-vous</h4>
          <%= link_to new_appointment_path, class: "btn btn-primary" do %>
            <i class="fas fa-plus"></i> Nouveau RDV
          <% end %>
        </div>
      </div>
    </div>

    <!-- Calendrier FullCalendar -->
    <div class="card shadow">
      <div class="card-body">
        <div id="calendar"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour les détails du RDV -->
<div class="modal fade" id="eventModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Détails du rendez-vous</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="eventDetails">
        <!-- Contenu dynamique -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <a href="#" id="eventEditLink" class="btn btn-primary">Voir/Modifier</a>
      </div>
    </div>
  </div>
</div>

<!-- FullCalendar CSS & Scripts -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

<style>
  /* Layout Sidebar + Calendrier */
  .calendar-pro-container {
    display: flex;
    gap: 20px;
    padding: 20px;
    background: #f5f6fa;
    min-height: calc(100vh - 100px);
  }

  .calendar-sidebar {
    width: 300px;
    flex-shrink: 0;
  }

  .calendar-main {
    flex: 1;
    min-width: 0;
  }

  /* Salle d'attente */
  .waiting-room-widget {
    max-height: 450px;
    overflow: hidden;
  }

  #waiting-list {
    max-height: 350px;
    overflow-y: auto;
  }

  .waiting-patient-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
    transition: background 0.2s;
  }

  .waiting-patient-item:hover {
    background: #f8f9fa;
  }

  .waiting-patient-item:last-child {
    border-bottom: none;
  }

  /* Styles FullCalendar */
  #calendar {
    height: 650px;
    background: white;
    overflow: hidden;
  }
  
  .fc-event {
    cursor: pointer;
    border-radius: 4px;
    padding: 2px 4px;
    font-size: 0.85rem;
  }
  
  .fc-event:hover {
    opacity: 0.85;
  }
  
  .fc-daygrid-event {
    white-space: normal !important;
  }
  
  .fc-toolbar-title {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
  }
  
  .fc-button {
    padding: 0.4rem 0.8rem !important;
    font-size: 0.9rem !important;
  }
  
  .fc-col-header-cell {
    background-color: #f8f9fa;
    font-weight: 600;
    padding: 10px 0;
  }
  
  .fc-day-today {
    background-color: #fff3cd !important;
  }
  
  /* Curseur pointer pour indiquer que les créneaux sont cliquables */
  .fc-timegrid-slot,
  .fc-daygrid-day {
    cursor: pointer;
  }
  
  .fc-timegrid-slot:hover,
  .fc-daygrid-day:hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
  }
</style>

<!-- FullCalendar Scripts -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/fr.global.min.js'></script>

<script>
  let calendarInstance = null;
  
  function initializeCalendar() {
    console.log('=== DÉBUT INITIALISATION CALENDRIER ===');
    
    // Éviter les doubles initialisations
    if (calendarInstance) {
      console.log('Calendrier déjà initialisé, destruction de l\'instance précédente');
      calendarInstance.destroy();
      calendarInstance = null;
    }
    
    const calendarEl = document.getElementById('calendar');
    const medecinFilter = document.getElementById('medecin-filter');
    
    if (!calendarEl) {
      console.error('❌ Élément #calendar non trouvé !');
      return;
    }
    
    if (typeof FullCalendar === 'undefined') {
      console.error('❌ FullCalendar non chargé !');
      setTimeout(initializeCalendar, 100); // Réessayer après 100ms
      return;
    }
    
    console.log('Création de l\'instance FullCalendar...');
    
    calendarInstance = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      locale: 'fr',
      timeZone: 'local', // Utiliser le timezone local du navigateur
      firstDay: 1, // Semaine commence le lundi
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
      },
      buttonText: {
        today: "Aujourd'hui",
        month: 'Mois',
        week: 'Semaine',
        day: 'Jour',
        list: 'Liste'
      },
      slotMinTime: '08:00:00',
      slotMaxTime: '20:00:00',
      slotDuration: '00:15:00',
      allDaySlot: false,
      height: 650,
      contentHeight: 550,
      nowIndicator: true,
      editable: true, // Permet le drag & drop
      droppable: true,
      eventResizableFromStart: true,
      
      // Charger les événements
      events: function(info, successCallback, failureCallback) {
        const medecinId = medecinFilter.value;
        const url = `/appointments/events_json?start=${info.startStr}&end=${info.endStr}&medecin_id=${medecinId}`;
        
        console.log('Chargement des événements depuis:', url);
        
        fetch(url)
          .then(response => {
            console.log('Réponse reçue:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Événements chargés:', data.length);
            successCallback(data);
          })
          .catch(error => {
            console.error('Erreur chargement événements:', error);
            failureCallback(error);
          });
      },
      
      // Clic sur un créneau vide pour créer un nouveau RDV
      dateClick: function(info) {
        // Formater la date et l'heure pour l'URL
        const dateTime = info.date.toISOString();
        const date = info.dateStr.split('T')[0]; // YYYY-MM-DD
        const time = info.date.toTimeString().slice(0, 5); // HH:MM
        
        // Vérifier si un médecin est sélectionné dans le filtre
        const medecinId = medecinFilter.value !== 'all' ? medecinFilter.value : '';
        
        // Construire l'URL avec les paramètres
        let url = `/appointments/new?date=${date}&time=${time}`;
        if (medecinId) {
          url += `&medecin_id=${medecinId}`;
        }
        
        // Rediriger vers le formulaire de création
        window.location.href = url;
      },
      
      // Clic sur un événement existant
      eventClick: function(info) {
        const event = info.event;
        const props = event.extendedProps;
        
        const modalBody = document.getElementById('eventDetails');
        modalBody.innerHTML = `
          <div class="mb-3">
            <strong><i class="fas fa-user"></i> Patient :</strong> ${props.patient}<br>
            <strong><i class="fas fa-phone"></i> Téléphone :</strong> ${props.telephone}<br>
            <strong><i class="fas fa-user-md"></i> Médecin :</strong> Dr ${props.medecin}<br>
            <strong><i class="fas fa-clock"></i> Horaire :</strong> ${event.start.toLocaleString('fr-FR', { 
              day: '2-digit', 
              month: 'long', 
              year: 'numeric',
              hour: '2-digit', 
              minute: '2-digit' 
            })}<br>
            <strong><i class="fas fa-info-circle"></i> Statut :</strong> 
            <span class="badge" style="background-color: ${event.backgroundColor}">${props.statut_fr}</span><br>
            ${props.motif ? `<strong><i class="fas fa-stethoscope"></i> Motif :</strong> ${props.motif}` : ''}
          </div>
        `;
        
        document.getElementById('eventEditLink').href = `/appointments/${event.id}`;
        
        const modal = new bootstrap.Modal(document.getElementById('eventModal'));
        modal.show();
      },
      
      // Drag & drop d'un événement
      eventDrop: function(info) {
        const event = info.event;
        
        if (!confirm(`Déplacer le rendez-vous de ${event.extendedProps.patient} au ${event.start.toLocaleString('fr-FR')} ?`)) {
          info.revert();
          return;
        }
        
        fetch(`/appointments/${event.id}/update_date`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          },
          body: JSON.stringify({
            start: event.start.toISOString()
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Recharger les événements pour afficher les bonnes heures et couleurs
            calendarInstance.refetchEvents();
            loadWaitingList();
          } else {
            alert('❌ Erreur : ' + data.errors.join(', '));
            info.revert();
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          alert('❌ Erreur lors du déplacement');
          info.revert();
        });
      },
      
      // Redimensionnement d'un événement
      eventResize: function(info) {
        alert('Fonctionnalité de redimensionnement à venir');
        info.revert();
      }
    });
    
    console.log('Instance créée, appel de render()...');
    calendarInstance.render();
    console.log('✅ Calendrier rendu !');
    
    // Filtre par médecin
    medecinFilter.addEventListener('change', function() {
      console.log('Changement de filtre médecin:', medecinFilter.value);
      calendarInstance.refetchEvents();
      loadWaitingList(); // Recharger la liste d'attente
    });
    
    // Charger la liste d'attente
    loadWaitingList();
    
    console.log('=== FIN INITIALISATION ===');
  }
  
  // Fonction pour charger la liste d'attente
  function loadWaitingList() {
    const today = new Date().toISOString().split('T')[0];
    const medecinFilterElement = document.getElementById('medecin-filter');
    const medecinId = medecinFilterElement ? medecinFilterElement.value : 'all';
    const url = `/appointments/events_json?start=${today}&end=${today}${medecinId && medecinId !== 'all' ? '&medecin_id=' + medecinId : ''}`;
    
    fetch(url)
      .then(response => response.json())
      .then(events => {
        // Filtrer les RDV en salle d'attente d'aujourd'hui
        const waitingAppointments = events.filter(event => {
          const eventDate = new Date(event.start).toDateString();
          const today = new Date().toDateString();
          return eventDate === today && event.extendedProps.statut === 'en_salle_attente';
        });
        
        // Trier par heure de début (ordre chronologique)
        waitingAppointments.sort((a, b) => new Date(a.start) - new Date(b.start));
        
        const waitingList = document.getElementById('waiting-list');
        const waitingCount = document.getElementById('waiting-count');
        
        if (!waitingList || !waitingCount) return;
        
        waitingCount.textContent = waitingAppointments.length;
        
        if (waitingAppointments.length === 0) {
          waitingList.innerHTML = `
            <div class="text-center text-muted p-3">
              <i class="fas fa-check-circle fa-2x mb-2"></i>
              <div>Aucun patient en attente</div>
            </div>
          `;
        } else {
          waitingList.innerHTML = waitingAppointments.map(apt => {
            const startTime = new Date(apt.start);
            return `
              <div class="waiting-patient-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>${apt.extendedProps.patient}</strong>
                    <div class="text-muted small">
                      RDV: ${startTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                  </div>
                  <a href="/appointments/${apt.id}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i>
                  </a>
                </div>
              </div>
            `;
          }).join('');
        }
      })
      .catch(error => {
        console.error('Erreur chargement liste d\'attente:', error);
        const waitingList = document.getElementById('waiting-list');
        if (waitingList) {
          waitingList.innerHTML = `
            <div class="text-center text-danger p-3">
              <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
              <div>Erreur de chargement</div>
            </div>
          `;
        }
      });
  }
  
  // Initialiser une seule fois
  let isInitialized = false;
  let refreshInterval = null;
  
  function safeInitialize() {
    // Éviter les initialisations multiples
    if (isInitialized && calendarInstance) {
      console.log('⚠️ Calendrier déjà initialisé, ignorer.');
      return;
    }
    initializeCalendar();
    isInitialized = true;
    
    // Rafraîchir la liste d'attente toutes les 30 secondes
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(() => {
      loadWaitingList();
    }, 30000);
  }
  
  // Écouter seulement turbo:load pour éviter les doublons
  document.addEventListener('turbo:load', safeInitialize);
  
  // Si la page est déjà chargée (premier chargement sans Turbo)
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    safeInitialize();
  }
  
  // Nettoyer lors de la navigation Turbo
  document.addEventListener('turbo:before-render', function() {
    if (calendarInstance) {
      console.log('Navigation Turbo détectée, destruction du calendrier');
      calendarInstance.destroy();
      calendarInstance = null;
      isInitialized = false;
    }
    if (refreshInterval) {
      clearInterval(refreshInterval);
      refreshInterval = null;
    }
  });
</script>
