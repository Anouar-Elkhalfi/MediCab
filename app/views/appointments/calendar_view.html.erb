<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-md-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-calendar-alt"></i> Calendrier des Rendez-vous</h2>
        <div>
          <%= link_to new_appointment_path, class: "btn btn-primary" do %>
            <i class="fas fa-plus"></i> Nouveau RDV
          <% end %>
        </div>
      </div>

      <!-- Filtres -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-4">
              <label class="form-label"><strong><i class="fas fa-user-md"></i> Filtrer par médecin :</strong></label>
              <select id="medecin-filter" class="form-select">
                <option value="all">Tous les médecins</option>
                <% @medecins.each do |medecin| %>
                  <option value="<%= medecin.id %>">Dr <%= medecin.full_name %></option>
                <% end %>
              </select>
            </div>
            <div class="col-md-8">
              <label class="form-label"><strong><i class="fas fa-palette"></i> Légende des couleurs :</strong></label>
              <div class="d-flex flex-wrap gap-3">
                <span class="badge" style="background-color: #f8bbd0; color: #000;">À venir</span>
                <span class="badge" style="background-color: #fff59d; color: #000;">En salle d'attente</span>
                <span class="badge" style="background-color: #a5d6a7; color: #000;">Vu</span>
                <span class="badge" style="background-color: #424242;">Encaissé</span>
                <span class="badge" style="background-color: #90caf9; color: #000;">Absent</span>
                <span class="badge" style="background-color: #b0bec5; color: #000;">Annulé</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Calendrier -->
      <div class="card shadow">
        <div class="card-body">
          <div id="calendar"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour les détails du RDV -->
<div class="modal fade" id="eventModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Détails du rendez-vous</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="eventDetails">
        <!-- Contenu dynamique -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <a href="#" id="eventEditLink" class="btn btn-primary">Voir/Modifier</a>
      </div>
    </div>
  </div>
</div>

<!-- FullCalendar CSS & Scripts -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

<style>
  /* Styles FullCalendar */
  #calendar {
    min-height: 700px;
    background: white;
  }
  
  .fc-event {
    cursor: pointer;
    border-radius: 4px;
    padding: 2px 4px;
    font-size: 0.85rem;
  }
  
  .fc-event:hover {
    opacity: 0.85;
  }
  
  .fc-daygrid-event {
    white-space: normal !important;
  }
  
  .fc-toolbar-title {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
  }
  
  .fc-button {
    padding: 0.4rem 0.8rem !important;
    font-size: 0.9rem !important;
  }
  
  .fc-col-header-cell {
    background-color: #f8f9fa;
    font-weight: 600;
    padding: 10px 0;
  }
  
  .fc-day-today {
    background-color: #fff3cd !important;
  }
</style>

<!-- FullCalendar Scripts -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/fr.global.min.js'></script>

<script>
  function initializeCalendar() {
    console.log('=== DÉBUT INITIALISATION CALENDRIER ===');
    console.log('FullCalendar disponible:', typeof FullCalendar);
    
    const calendarEl = document.getElementById('calendar');
    console.log('Élément calendrier trouvé:', calendarEl);
    
    const medecinFilter = document.getElementById('medecin-filter');
    
    if (!calendarEl) {
      console.error('❌ Élément #calendar non trouvé !');
      return;
    }
    
    if (typeof FullCalendar === 'undefined') {
      console.error('❌ FullCalendar non chargé !');
      return;
    }
    
    console.log('Création de l\'instance FullCalendar...');
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      locale: 'fr',
      firstDay: 1, // Semaine commence le lundi
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
      },
      buttonText: {
        today: "Aujourd'hui",
        month: 'Mois',
        week: 'Semaine',
        day: 'Jour',
        list: 'Liste'
      },
      slotMinTime: '08:00:00',
      slotMaxTime: '20:00:00',
      slotDuration: '00:15:00',
      allDaySlot: false,
      height: 'auto',
      nowIndicator: true,
      editable: true, // Permet le drag & drop
      droppable: true,
      eventResizableFromStart: true,
      
      // Charger les événements
      events: function(info, successCallback, failureCallback) {
        const medecinId = medecinFilter.value;
        const url = `/appointments/events_json?start=${info.startStr}&end=${info.endStr}&medecin_id=${medecinId}`;
        
        console.log('Chargement des événements depuis:', url);
        
        fetch(url)
          .then(response => {
            console.log('Réponse reçue:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Événements chargés:', data.length);
            successCallback(data);
          })
          .catch(error => {
            console.error('Erreur chargement événements:', error);
            failureCallback(error);
          });
      },
      
      // Clic sur un événement
      eventClick: function(info) {
        const event = info.event;
        const props = event.extendedProps;
        
        const modalBody = document.getElementById('eventDetails');
        modalBody.innerHTML = `
          <div class="mb-3">
            <strong><i class="fas fa-user"></i> Patient :</strong> ${props.patient}<br>
            <strong><i class="fas fa-phone"></i> Téléphone :</strong> ${props.telephone}<br>
            <strong><i class="fas fa-user-md"></i> Médecin :</strong> Dr ${props.medecin}<br>
            <strong><i class="fas fa-clock"></i> Horaire :</strong> ${event.start.toLocaleString('fr-FR', { 
              day: '2-digit', 
              month: 'long', 
              year: 'numeric',
              hour: '2-digit', 
              minute: '2-digit' 
            })}<br>
            <strong><i class="fas fa-info-circle"></i> Statut :</strong> 
            <span class="badge" style="background-color: ${event.backgroundColor}">${props.statut_fr}</span><br>
            ${props.motif ? `<strong><i class="fas fa-stethoscope"></i> Motif :</strong> ${props.motif}` : ''}
          </div>
        `;
        
        document.getElementById('eventEditLink').href = `/appointments/${event.id}`;
        
        const modal = new bootstrap.Modal(document.getElementById('eventModal'));
        modal.show();
      },
      
      // Drag & drop d'un événement
      eventDrop: function(info) {
        const event = info.event;
        
        if (!confirm(`Déplacer le rendez-vous de ${event.extendedProps.patient} au ${event.start.toLocaleString('fr-FR')} ?`)) {
          info.revert();
          return;
        }
        
        fetch(`/appointments/${event.id}/update_date`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          },
          body: JSON.stringify({
            start: event.start.toISOString()
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('✅ ' + data.message);
          } else {
            alert('❌ Erreur : ' + data.errors.join(', '));
            info.revert();
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          alert('❌ Erreur lors du déplacement');
          info.revert();
        });
      },
      
      // Redimensionnement d'un événement
      eventResize: function(info) {
        alert('Fonctionnalité de redimensionnement à venir');
        info.revert();
      }
    });
    
    console.log('Instance créée, appel de render()...');
    calendar.render();
    console.log('✅ Calendrier rendu !');
    console.log('Dimensions calendrier:', calendarEl.offsetWidth, 'x', calendarEl.offsetHeight);
    
    // Filtre par médecin
    medecinFilter.addEventListener('change', function() {
      console.log('Changement de filtre médecin:', medecinFilter.value);
      calendar.refetchEvents();
    });
    
    console.log('=== FIN INITIALISATION ===');
  }
  
  // Écouter les événements Turbo ET le chargement initial
  document.addEventListener('DOMContentLoaded', initializeCalendar);
  document.addEventListener('turbo:load', initializeCalendar);
  document.addEventListener('turbo:render', initializeCalendar);
</script>
