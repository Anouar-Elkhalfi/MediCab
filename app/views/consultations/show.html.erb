<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <div class="card border-success">
        <div class="card-header bg-success text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="mb-0">
              <i class="fas fa-notes-medical"></i> Compte Rendu de Consultation
            </h3>
            <div>
              <%= link_to "← Retour au RDV", appointment_path(@appointment), class: "btn btn-light btn-sm" %>
              <% if current_user.medecin_or_owner? %>
                <%= link_to "Modifier", edit_appointment_consultation_path(@appointment, @consultation), class: "btn btn-warning btn-sm" %>
                <%= link_to "Supprimer", appointment_consultation_path(@appointment, @consultation), 
                           method: :delete,
                           data: { turbo_method: :delete, turbo_confirm: "Êtes-vous sûr ?" },
                           class: "btn btn-danger btn-sm" %>
              <% end %>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Info patient et RDV -->
          <div class="alert alert-info mb-4">
            <div class="row">
              <div class="col-md-4">
                <strong>Patient:</strong> <%= @appointment.patient.nom_complet %><br>
                <strong>N° Dossier:</strong> <%= @appointment.patient.numero_dossier %>
              </div>
              <div class="col-md-4">
                <strong>Date consultation:</strong> <%= l(@appointment.date_rdv, format: :long) %><br>
                <strong>Heure:</strong> <%= @appointment.heure_debut.strftime("%H:%M") %>
              </div>
              <div class="col-md-4">
                <strong>Médecin:</strong> Dr <%= @appointment.medecin.last_name %> <%= @appointment.medecin.first_name %>
              </div>
            </div>
          </div>

          <!-- Section 1: Motif et Antécédents -->
          <% if @consultation.motif.present? || @consultation.antecedents.present? %>
            <h5 class="text-primary border-bottom pb-2 mb-3"><i class="fas fa-clipboard-list"></i> Informations Générales</h5>
            <div class="row mb-4">
              <% if @consultation.motif.present? %>
                <div class="col-md-6 mb-3">
                  <h6 class="text-primary"><i class="fas fa-question-circle"></i> Motif de consultation</h6>
                  <div class="p-3 bg-light rounded">
                    <%= simple_format(@consultation.motif) %>
                  </div>
                </div>
              <% end %>
              
              <% if @consultation.antecedents.present? %>
                <div class="col-md-6 mb-3">
                  <h6 class="text-primary"><i class="fas fa-history"></i> Antécédents médicaux</h6>
                  <div class="p-3 bg-light rounded">
                    <%= simple_format(@consultation.antecedents) %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>

          <!-- Section 2: Examen et Diagnostic -->
          <h5 class="text-success border-bottom pb-2 mb-3"><i class="fas fa-stethoscope"></i> Examen et Diagnostic</h5>
          <div class="row mb-4">
            <% if @consultation.examen_clinique.present? %>
              <div class="col-md-6 mb-3">
                <h6 class="text-success"><i class="fas fa-user-md"></i> Examen clinique</h6>
                <div class="p-3 bg-light rounded">
                  <%= simple_format(@consultation.examen_clinique) %>
                </div>
              </div>
            <% end %>

            <% if @consultation.examens_complementaires.present? %>
              <div class="col-md-6 mb-3">
                <h6 class="text-success"><i class="fas fa-vial"></i> Examens complémentaires</h6>
                <div class="p-3 bg-light rounded">
                  <%= simple_format(@consultation.examens_complementaires) %>
                </div>
              </div>
            <% end %>

            <div class="col-md-6 mb-3">
              <h6 class="text-success"><i class="fas fa-diagnoses"></i> Diagnostic</h6>
              <div class="p-3 bg-success bg-opacity-10 rounded border border-success">
                <strong><%= simple_format(@consultation.diagnostic) %></strong>
              </div>
            </div>

            <% if @consultation.conclusion.present? %>
              <div class="col-md-6 mb-3">
                <h6 class="text-success"><i class="fas fa-check-circle"></i> Conclusion</h6>
                <div class="p-3 bg-light rounded">
                  <%= simple_format(@consultation.conclusion) %>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Section 3: Traitement et Suivi -->
          <h5 class="text-info border-bottom pb-2 mb-3"><i class="fas fa-pills"></i> Traitement et Suivi</h5>
          <div class="row mb-4">
            <% if @consultation.traitement.present? %>
              <div class="col-md-6 mb-3">
                <h6 class="text-info"><i class="fas fa-prescription-bottle"></i> Traitement prescrit</h6>
                <div class="p-3 bg-light rounded">
                  <%= simple_format(@consultation.traitement) %>
                </div>
              </div>
            <% end %>

            <% if @consultation.ordonnance.present? %>
              <div class="col-md-6 mb-3">
                <h6 class="text-warning"><i class="fas fa-file-prescription"></i> Ordonnance détaillée</h6>
                <div class="p-3 bg-warning bg-opacity-10 rounded border border-warning">
                  <%= simple_format(@consultation.ordonnance) %>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Observations -->
          <% if @consultation.observations.present? %>
            <div class="mb-4">
              <h6 class="text-info"><i class="fas fa-clipboard"></i> Observations</h6>
              <div class="p-3 bg-light rounded">
                <%= simple_format(@consultation.observations) %>
              </div>
            </div>
          <% end %>

          <!-- Notes internes (visibles uniquement pour les médecins) -->
          <% if @consultation.notes_internes.present? %>
            <div class="mb-4">
              <h6 class="text-secondary"><i class="fas fa-lock"></i> Notes internes (confidentielles)</h6>
              <div class="p-3 bg-secondary bg-opacity-10 rounded border border-secondary">
                <%= simple_format(@consultation.notes_internes) %>
              </div>
            </div>
          <% end %>

          <!-- Prochain RDV -->
          <% if @consultation.prochain_rdv.present? %>
            <div class="alert alert-success">
              <i class="fas fa-calendar-check"></i> 
              <strong>Prochain rendez-vous prévu:</strong> <%= l(@consultation.prochain_rdv, format: :long) %>
            </div>
          <% end %>

          <!-- Confidentialité -->
          <div class="alert alert-warning mt-4">
            <i class="fas fa-lock"></i> 
            <strong>Confidentiel:</strong> Ce document est strictement confidentiel et réservé aux médecins.
          </div>

          <!-- Timestamps -->
          <div class="text-muted small mt-3">
            <strong>Créé le:</strong> <%= l(@consultation.created_at, format: :long) %>
            <% if @consultation.updated_at != @consultation.created_at %>
              <br><strong>Dernière modification:</strong> <%= l(@consultation.updated_at, format: :long) %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
